const _0x14a1ea=_0xfa55;(function(_0x404c43,_0x22c14a){const _0x463fe2=_0xfa55,_0x620ef6=_0x404c43();while(!![]){try{const _0x16ef5e=-parseInt(_0x463fe2(0x235))/(-0x15d*0x2+0x19af+-0x16f4)*(-parseInt(_0x463fe2(0x226))/(0x1*0x515+0x655*0x2+-0x11bd))+parseInt(_0x463fe2(0x254))/(-0x88d*0x3+0x1594+-0x2*-0x20b)+parseInt(_0x463fe2(0x1d8))/(0x120e+-0x1266+0x5c)*(parseInt(_0x463fe2(0x1eb))/(-0x1f92+0x23b5*-0x1+0x434c))+parseInt(_0x463fe2(0x1fa))/(0x595*-0x2+0x1872+0x1*-0xd42)+-parseInt(_0x463fe2(0x1b3))/(-0x1*0x119f+-0x2672+0x3818)+parseInt(_0x463fe2(0x1be))/(0x9*0x3ce+0x355*-0x1+-0xf*0x20f)*(-parseInt(_0x463fe2(0x1f0))/(0x1*-0x1cac+-0x23ab+-0x5*-0xce0))+-parseInt(_0x463fe2(0x23f))/(-0x1e4*0x13+0x1*0x1f3+0x2203)*(-parseInt(_0x463fe2(0x243))/(-0x476*-0x4+-0x22a4+-0x59d*-0x3));if(_0x16ef5e===_0x22c14a)break;else _0x620ef6['push'](_0x620ef6['shift']());}catch(_0x104172){_0x620ef6['push'](_0x620ef6['shift']());}}}(_0xed4c,0x5*0xe423+-0x4a79f+0x2b4c*0x10));import{DateTime}from'luxon';import{db}from'../utils/database.js';function _0xfa55(_0x40e1d3,_0x300d9f){_0x40e1d3=_0x40e1d3-(0x1e7+-0x1cc5+0x1c83);const _0x37fa1b=_0xed4c();let _0x5c70af=_0x37fa1b[_0x40e1d3];return _0x5c70af;}import{warn,error}from'../utils/logger.js';import{getConfig}from'../utils/config.js';export const name='updates';export const version='1.2.0';export const priority=0x183d+-0x18f9+0x120;export const commands=['start','stop',_0x14a1ea(0x20c)];let botRef=null,sendApi=null,schedulerInterval=null,schedulerRunning=![],lastCheckRunDate=null;function _0xed4c(){const _0x2ae686=['ates`\x20to\x20o','\x200,\x20(SELEC','message','\x20ON\x20(1)\x0a\x20\x20','S:\x20','o\x20fetch\x20up','te_mtime)\x20','tart\x20updat','json','ll\x20retries','ng\x20your\x20st','STS\x20user_u','3jUAZBe','s\x20(\x0a\x20\x20\x20\x20\x20\x20','signal','\x20found\x20thi',']\x20Failed\x20t','o\x20date.\x20No','o\x20process\x20','cribed\x20use','ER\x20DEFAULT','bled,\x20last','10LlHBNC','es\x20found.','key','stop\x20updat','1418901cnOAdo','bscribed\x20f','object','.\x20Please\x20t','\x20`stop\x20upd','RE\x20user_ji','date\x20messa','rs\x20from\x20DB','Default\x20to','https://i-','ates.','update_pre','\x201,\x20--\x20Req','undefined','connection','UPDATES','\x20user\x20','325950hyTDgN','T\x20last_upd','bot\x20instan','@g.us','might\x20get\x20','content','VALUES\x20(?,','date_prefs','INSERT\x20OR\x20',']\x20onMessag','ready\x20up\x20t','_update_mt','method\x20ava','uirement:\x20','rom\x20automa','\x20after\x20man','ate_mtime\x20','ND_DELAY_M','ase\x20try\x20ag','a\x20initiali','ic\x2024h\x20upd','ARY\x20KEY,\x0a\x20','ater.','ual\x20check','ge\x20after\x20a','o\x20get\x20subs','abort','ser_update','catch','\x20WHERE\x20use',',\x20enabled,','2208465bRZnMi','Run\x20`start','TO\x20user_up','s\x20left:\x20','atus.\x20You\x20','o\x20update\x20m','ime\x20TEXT\x0a\x20','close','e-subscrib','ry\x20again\x20l','s\x20update,\x20','184HZRVpT','ouldn\x27t\x20ch','UPDATE\x20use','sendMessag','JSON\x20struc','tes','ATE\x20TABLE\x20','user_updat','eck\x20for\x20up','references','trim','dates\x20righ','to\x20get\x20aut','toISODate','ge.\x20Retrie','dates.\x0a\x0aRu','ime\x20FROM\x20u','FROM\x20user_','es`\x20at\x20any','led','function','omatic\x2024h','t\x20send\x20to\x20','OUT_MS','ouble\x20savi','\x20updates.','4AAgbUl','updates\x20en','\x0a\x0a---\x0a\x0a','o\x20read\x20con','\x20updates`\x20','sock','ERE\x20enable','\x20\x20\x20\x20\x20\x20\x20ena','or!\x20status','dates`\x20at\x20','w\x20update!\x0a','enabled','ser_jid\x20=\x20','RETRY_DELA','remoteJid','UPDATES_UR',']\x20Schedule','update\x20for','✅\x20You\x20are\x20','663335JbAgUQ','\x20\x20\x20\x20\x20);\x0a\x20\x20','e\x20error','mtime','\x20\x20\x20\x20\x20\x20last','117711MNclDm','No\x20new\x20upd','now\x20subscr','of\x20automat','\x20been\x20unsu','\x20(user_jid','toLowerCas','open','d\x20=\x20?','\x20TEXT\x20PRIM','1012614smHjqY','tct.com/up','o\x20opt-out.','ble.\x20Canno','Y_MS','sage\x20to\x20','API\x20availa','\x20response',']\x20Invalid\x20','time\x20FROM\x20','this\x20again','MESSAGE_SE','all','IF\x20NOT\x20EXI','TIME_ZONE','o\x20send\x20mes','tomatic\x20up','minute','new?','\x0a\x0a---\x0a\x0aRun','d\x20=\x201','\x20new\x20updat','run',']\x20No\x20send\x20','SELECT\x20ena','\x0a---\x0a\x0a','?))','last_updat','_prefs\x20WHE','endsWith','exec','You\x20are\x20al','but\x20had\x20tr','_mtime\x20=\x20?','readyState','time\x20for\x20','Sorry,\x20I\x20c','\x20last_upda','r\x20tick\x20fai','now','\x20?,\x20?)','e_mtime','user_jid','n\x20`stop\x20up','161026FpCCVI','setZone','t_update_m'];_0xed4c=function(){return _0x2ae686;};return _0xed4c();}const DEFAULTS={'TIME_ZONE':'UTC','UPDATES_URL':_0x14a1ea(0x24c)+_0x14a1ea(0x1fb)+'dates','RETRY_DELAY_MS':(0x1*-0xd83+-0x4a*0x1c+0x159d)*(0x21*0xa5+0x2*-0xcd7+0x4a5)*(-0x2428+-0xe3*0x10+0x70*0x7c),'FETCH_TIMEOUT_MS':(-0x10bd+-0x4*-0x2cd+-0x5a7*-0x1)*(-0x1eca+0x10d1+-0x11e1*-0x1),'MESSAGE_SEND_DELAY_MS':0x1f4};let CONFIG={...DEFAULTS};async function ensureSchema(){const _0x436dfe=_0x14a1ea;try{await db[_0x436dfe(0x218)]('\x0a\x20\x20\x20\x20\x20\x20CRE'+_0x436dfe(0x1c4)+_0x436dfe(0x207)+_0x436dfe(0x234)+'pdate_pref'+_0x436dfe(0x236)+'\x20\x20user_jid'+_0x436dfe(0x1f9)+_0x436dfe(0x1a9)+_0x436dfe(0x1df)+'bled\x20INTEG'+_0x436dfe(0x23d)+_0x436dfe(0x24f)+_0x436dfe(0x261)+_0x436dfe(0x24b)+_0x436dfe(0x22c)+_0x436dfe(0x1ef)+'_update_mt'+_0x436dfe(0x1b9)+_0x436dfe(0x1ec)+'\x20\x20');}catch(_0x4992c5){error(_0x4992c5,'['+name+(']\x20DB\x20schem'+_0x436dfe(0x1a7)+'zation\x20fai'+_0x436dfe(0x1d1)));throw _0x4992c5;}}function setupApi(_0x30ea98){const _0x3dfc2b=_0x14a1ea;botRef=_0x30ea98;if(botRef){if(typeof botRef[_0x3dfc2b(0x1c1)+'e']===_0x3dfc2b(0x1d2))sendApi=(_0x4a62b2,_0x459d98)=>botRef[_0x3dfc2b(0x1c1)+'e'](_0x4a62b2,_0x459d98);else botRef[_0x3dfc2b(0x1dd)]&&typeof botRef[_0x3dfc2b(0x1dd)][_0x3dfc2b(0x1c1)+'e']==='function'?sendApi=(_0x3cfe29,_0x49d6aa)=>botRef[_0x3dfc2b(0x1dd)][_0x3dfc2b(0x1c1)+'e'](_0x3cfe29,_0x49d6aa):(sendApi=null,warn('['+name+(_0x3dfc2b(0x211)+_0x3dfc2b(0x260)+'ilable\x20on\x20'+_0x3dfc2b(0x256)+'ce')));}}async function safeSend(_0x24b4e8,_0x47428e){const _0x46626e=_0x14a1ea;if(!sendApi){error('['+name+(_0x46626e(0x211)+_0x46626e(0x200)+_0x46626e(0x1fd)+_0x46626e(0x1d4))+_0x24b4e8);return;}if(!_0x24b4e8||!_0x47428e)return;try{await sendApi(_0x24b4e8,{'text':_0x47428e});}catch(_0x394c14){error(_0x394c14,'['+name+(_0x46626e(0x239)+_0x46626e(0x209)+_0x46626e(0x1ff))+_0x24b4e8);}}async function fetchUpdatesWithRetry(_0x2e1928=0x25af+0x5d6*-0x2+-0x1a01){const _0x3785df=_0x14a1ea;try{const _0x46d6e3=new AbortController(),_0x2cafb8=setTimeout(()=>_0x46d6e3[_0x3785df(0x1ae)](),CONFIG['FETCH_TIME'+_0x3785df(0x1d5)]),_0x421b5d=await fetch(CONFIG[_0x3785df(0x1e7)+'L'],{'signal':_0x46d6e3[_0x3785df(0x237)],'headers':{'Cache-Control':'no-cache','Pragma':'no-cache'}});clearTimeout(_0x2cafb8);if(!_0x421b5d['ok'])throw new Error('['+name+(']\x20HTTP\x20err'+_0x3785df(0x1e0)+':\x20')+_0x421b5d['status']);const _0x2fe500=await _0x421b5d[_0x3785df(0x231)]();if(typeof _0x2fe500?.['content']===_0x3785df(0x250)||typeof _0x2fe500?.[_0x3785df(0x1ee)]===_0x3785df(0x250))throw new Error('['+name+(_0x3785df(0x202)+_0x3785df(0x1c2)+'ture\x20from\x20'+_0x3785df(0x1d9)+'dpoint'));if(_0x2fe500[_0x3785df(0x1ee)]!==null&&typeof _0x2fe500[_0x3785df(0x1ee)]!=='string')throw new Error('['+name+(_0x3785df(0x202)+'mtime\x20form'+'at\x20in\x20JSON'+_0x3785df(0x201)));return{'content':_0x2fe500[_0x3785df(0x259)]||'','mtime':_0x2fe500['mtime']};}catch(_0x2532e9){return error(_0x2532e9,'['+name+(_0x3785df(0x239)+'o\x20fetch\x20up'+'date\x20messa'+_0x3785df(0x1cc)+_0x3785df(0x1b6))+_0x2e1928),_0x2e1928>-0x184*0x13+0x1f*0xc1+0x3*0x1cf?(await new Promise(_0xde7fd6=>setTimeout(_0xde7fd6,CONFIG[_0x3785df(0x1e5)+_0x3785df(0x1fe)])),fetchUpdatesWithRetry(_0x2e1928-(-0x21*-0x5d+0x173f*-0x1+0xb43))):(error('['+name+(_0x3785df(0x239)+_0x3785df(0x22e)+_0x3785df(0x249)+_0x3785df(0x1ac)+_0x3785df(0x232)+'.')),null);}}async function runUpdateCheckForAllUsers(){const _0x5d1e5c=_0x14a1ea,_0x1ed3a4=await fetchUpdatesWithRetry();if(!_0x1ed3a4||!_0x1ed3a4[_0x5d1e5c(0x259)]||!_0x1ed3a4['mtime'])return;const {content:_0x2f59ac,mtime:_0xf48b9a}=_0x1ed3a4;let _0x3d4b6b=[];try{_0x3d4b6b=await db[_0x5d1e5c(0x206)]('SELECT\x20use'+'r_jid,\x20las'+_0x5d1e5c(0x228)+_0x5d1e5c(0x203)+_0x5d1e5c(0x1c5)+'e_prefs\x20WH'+_0x5d1e5c(0x1de)+_0x5d1e5c(0x20e));}catch(_0x122721){error(_0x122721,'['+name+(']\x20Failed\x20t'+_0x5d1e5c(0x1ad)+_0x5d1e5c(0x23c)+_0x5d1e5c(0x24a)));return;}if(!_0x3d4b6b['length'])return;const _0x4e194d=_0x5d1e5c(0x20d)+_0x5d1e5c(0x247)+_0x5d1e5c(0x229)+'pt-out.',_0x2c0e7b=_0x2f59ac+_0x4e194d;for(const _0x5f1679 of _0x3d4b6b){try{_0x5f1679[_0x5d1e5c(0x215)+_0x5d1e5c(0x223)]!==_0xf48b9a&&(await safeSend(_0x5f1679[_0x5d1e5c(0x224)],_0x2c0e7b),await db[_0x5d1e5c(0x210)](_0x5d1e5c(0x1c0)+'r_update_p'+'refs\x20SET\x20l'+'ast_update'+_0x5d1e5c(0x21b)+_0x5d1e5c(0x1b1)+'r_jid\x20=\x20?',[_0xf48b9a,_0x5f1679['user_jid']]),await new Promise(_0x243d7c=>setTimeout(_0x243d7c,CONFIG[_0x5d1e5c(0x205)+_0x5d1e5c(0x1a5)+'S'])));}catch(_0x24c234){error(_0x24c234,'['+name+(_0x5d1e5c(0x239)+_0x5d1e5c(0x23b)+_0x5d1e5c(0x1e9)+_0x5d1e5c(0x253))+_0x5f1679[_0x5d1e5c(0x224)]);}}}async function handleNewCheck(_0x30defa){const _0x50869e=_0x14a1ea;let _0x562a94;try{_0x562a94=await db['get'](_0x50869e(0x212)+_0x50869e(0x23e)+_0x50869e(0x25f)+_0x50869e(0x1ce)+_0x50869e(0x1af)+_0x50869e(0x216)+_0x50869e(0x248)+_0x50869e(0x1f8),[_0x30defa]);}catch(_0x126f1f){error(_0x126f1f,'['+name+(']\x20Failed\x20t'+'o\x20get\x20user'+'\x20prefs\x20for'+'\x20')+_0x30defa),await safeSend(_0x30defa,_0x50869e(0x21e)+_0x50869e(0x1bf)+'eck\x20your\x20p'+_0x50869e(0x1c7)+_0x50869e(0x246)+_0x50869e(0x1bc)+_0x50869e(0x1aa));return;}const _0x5d57c1=_0x562a94?.[_0x50869e(0x1e3)]??0xdbe+-0x1ed5+-0x88c*-0x2,_0x7daf3e=_0x562a94?.[_0x50869e(0x215)+'e_mtime'],_0xd9afc3=await fetchUpdatesWithRetry(0x5da+-0x29d*0x3+0x1e*0x11);let _0x3c93d8='';if(!_0xd9afc3)_0x3c93d8=_0x50869e(0x21e)+_0x50869e(0x1bf)+_0x50869e(0x1c6)+_0x50869e(0x1c9)+'t\x20now.\x20Ple'+_0x50869e(0x1a6)+'ain\x20later.';else{if(!_0xd9afc3[_0x50869e(0x259)]||!_0xd9afc3['mtime'])_0x3c93d8=_0x50869e(0x1f1)+'ates\x20found'+'.';else{if(_0xd9afc3['mtime']===_0x7daf3e)_0x3c93d8=_0x50869e(0x219)+_0x50869e(0x25e)+_0x50869e(0x23a)+_0x50869e(0x20f)+_0x50869e(0x240);else{const {content:_0x309103,mtime:_0xa5da44}=_0xd9afc3;_0x3c93d8='Found\x20a\x20ne'+_0x50869e(0x1e2)+_0x50869e(0x213)+_0x309103;try{await db[_0x50869e(0x210)](_0x50869e(0x25c)+'REPLACE\x20IN'+'TO\x20user_up'+_0x50869e(0x25b)+_0x50869e(0x1f5)+_0x50869e(0x1b2)+_0x50869e(0x21f)+_0x50869e(0x22f)+'VALUES\x20(?,'+_0x50869e(0x222),[_0x30defa,_0x5d57c1,_0xa5da44]);}catch(_0x1714a6){error(_0x1714a6,'['+name+(_0x50869e(0x239)+_0x50869e(0x1b8)+_0x50869e(0x21d))+_0x30defa+(_0x50869e(0x263)+_0x50869e(0x1ab))),_0x3c93d8+='\x0a\x0a(Note:\x20I'+_0x50869e(0x238)+_0x50869e(0x1bd)+_0x50869e(0x21a)+_0x50869e(0x1d6)+_0x50869e(0x233)+_0x50869e(0x1b7)+_0x50869e(0x258)+_0x50869e(0x204)+'.)';}}}}const _0x3e0774=_0x5d57c1?'Run\x20`stop\x20'+'updates`\x20t'+'o\x20opt-out\x20'+_0x50869e(0x1f3)+_0x50869e(0x1a8)+_0x50869e(0x24d):_0x50869e(0x1b4)+_0x50869e(0x1dc)+_0x50869e(0x1ca)+_0x50869e(0x1d3)+_0x50869e(0x1d7);await safeSend(_0x30defa,_0x3c93d8+_0x50869e(0x1da)+_0x3e0774);}async function _schedulerTick(){const _0x517742=_0x14a1ea;if(schedulerRunning)return;try{schedulerRunning=!![];const _0x327e08=DateTime[_0x517742(0x221)]()[_0x517742(0x227)](CONFIG[_0x517742(0x208)]);if(_0x327e08['hour']===-0x1006+0x19d9+-0x9d3&&_0x327e08[_0x517742(0x20b)]===0x6fc*-0x5+0x2*-0x192+0xcb*0x30){const _0x5f79ea=_0x327e08[_0x517742(0x1cb)]();lastCheckRunDate!==_0x5f79ea&&(lastCheckRunDate=_0x5f79ea,await runUpdateCheckForAllUsers());}}catch(_0x1af0f2){error(_0x1af0f2,'['+name+(_0x517742(0x1e8)+_0x517742(0x220)+_0x517742(0x1d1)));}finally{schedulerRunning=![];}}function startScheduler(){stopScheduler();const _0x1f0a47=0x184ec+-0x19bd6+-0x1*-0x1014a-Date['now']()%(0x1*0x2487+-0x1cb4c+0x29125);setTimeout(()=>{const _0x31081d=_0xfa55;_schedulerTick()[_0x31081d(0x1b0)](()=>{}),schedulerInterval=setInterval(()=>_schedulerTick()[_0x31081d(0x1b0)](()=>{}),(-0x1aed*-0x1+-0x1*0xce9+-0xdc8)*(-0x982*-0x4+0x1bb8+-0x3dd8));},_0x1f0a47);}function stopScheduler(){schedulerInterval&&(clearInterval(schedulerInterval),schedulerInterval=null),schedulerRunning=![];}export async function initialize(_0x3d1d83){const _0x446017=_0x14a1ea;setupApi(_0x3d1d83);try{const _0x281730=getConfig()||{};_0x281730['UPDATES']&&typeof _0x281730[_0x446017(0x252)]===_0x446017(0x245)&&(CONFIG={...CONFIG,..._0x281730[_0x446017(0x252)]});}catch(_0x5e0060){warn('['+name+(_0x446017(0x239)+_0x446017(0x1db)+'fig.UPDATE'+_0x446017(0x22d))+(_0x5e0060?.[_0x446017(0x22b)]||_0x5e0060));}await ensureSchema(),botRef&&typeof botRef['on']===_0x446017(0x1d2)&&botRef['on'](_0x446017(0x251)+'.update',_0x3063b1=>{const _0x57a5a0=_0x446017;if(_0x3063b1['connection']===_0x57a5a0(0x1f7))startScheduler();else _0x3063b1['connection']===_0x57a5a0(0x1ba)&&stopScheduler();}),botRef['sock']?.['ws']?.[_0x446017(0x21c)]===0x3f6+0xb7*0x2d+-0x2420&&startScheduler();}export async function onMessage(_0x269522,_0x51a353){const _0x4288dc=_0x14a1ea;try{if(!_0x269522['key']?.['remoteJid']||_0x269522[_0x4288dc(0x241)][_0x4288dc(0x1e6)][_0x4288dc(0x217)](_0x4288dc(0x257)))return;const _0x81d997=_0x269522[_0x4288dc(0x241)][_0x4288dc(0x1e6)],_0x12447d=(_0x269522['text']||'')[_0x4288dc(0x1c8)]()[_0x4288dc(0x1f6)+'e']();if(_0x12447d==='start\x20upda'+_0x4288dc(0x1c3)){const _0xd9fa38=await fetchUpdatesWithRetry(0x1*-0x1ddb+-0x1e92+0x7*0x8a2),_0x1c3dbb=_0xd9fa38?.['mtime']||null;await db[_0x4288dc(0x210)](_0x4288dc(0x25c)+'REPLACE\x20IN'+'TO\x20user_up'+_0x4288dc(0x25b)+'\x20(user_jid'+_0x4288dc(0x1b2)+_0x4288dc(0x21f)+'te_mtime)\x20'+_0x4288dc(0x25a)+'\x201,\x20?)',[_0x81d997,_0x1c3dbb]),await safeSend(_0x81d997,_0x4288dc(0x1ea)+_0x4288dc(0x1f2)+'ibed\x20to\x20au'+_0x4288dc(0x20a)+_0x4288dc(0x1cd)+_0x4288dc(0x225)+_0x4288dc(0x1e1)+'any\x20time\x20t'+_0x4288dc(0x1fc));}else{if(_0x12447d===_0x4288dc(0x242)+'es')await db[_0x4288dc(0x210)]('INSERT\x20OR\x20'+'REPLACE\x20IN'+_0x4288dc(0x1b5)+_0x4288dc(0x25b)+'\x20(user_jid'+_0x4288dc(0x1b2)+_0x4288dc(0x21f)+'te_mtime)\x20'+_0x4288dc(0x25a)+_0x4288dc(0x22a)+_0x4288dc(0x255)+_0x4288dc(0x264)+_0x4288dc(0x1cf)+_0x4288dc(0x24e)+'fs\x20WHERE\x20u'+_0x4288dc(0x1e4)+_0x4288dc(0x214),[_0x81d997,_0x81d997]),await safeSend(_0x81d997,'❌\x20You\x20have'+_0x4288dc(0x1f4)+_0x4288dc(0x244)+_0x4288dc(0x262)+'tic\x20update'+'s.\x0a\x0aRun\x20`s'+_0x4288dc(0x230)+_0x4288dc(0x1d0)+'\x20time\x20to\x20r'+_0x4288dc(0x1bb)+'e.');else _0x12447d===_0x4288dc(0x20c)&&await handleNewCheck(_0x81d997);}}catch(_0x4feb5e){error(_0x4feb5e,'['+name+(_0x4288dc(0x25d)+_0x4288dc(0x1ed)));}}export async function cleanup(){stopScheduler(),botRef=null,sendApi=null;}