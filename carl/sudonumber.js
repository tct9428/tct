const _0x150093=_0x529d;(function(_0xcf751a,_0x32dec1){const _0x152022=_0x529d,_0x1cf24b=_0xcf751a();while(!![]){try{const _0x384d4b=parseInt(_0x152022(0x117))/(0x973+0xf*0x87+-0x115b)+parseInt(_0x152022(0xb7))/(0x18a*0xd+0xe8d+-0x6e9*0x5)*(-parseInt(_0x152022(0x115))/(-0xaa8+0x9e1*0x1+0x1*0xca))+-parseInt(_0x152022(0xca))/(-0x20e2+0x209*0xa+0xc8c)+parseInt(_0x152022(0xf9))/(-0xeb3+0x3a4*-0x4+0x1d48)*(-parseInt(_0x152022(0x108))/(-0x1*-0x259+0x1423*0x1+-0x1676))+-parseInt(_0x152022(0xcf))/(-0x2690+-0x408+0x2a9f)*(-parseInt(_0x152022(0xb6))/(-0x1ffc+0x23c7+-0x3c3))+-parseInt(_0x152022(0xf0))/(0x3*0x465+0x83a+0x1*-0x1560)*(parseInt(_0x152022(0xd3))/(0x150a+0x792+-0xe49*0x2))+-parseInt(_0x152022(0xc6))/(-0xc3d+0x2*-0xce0+0x2608)*(-parseInt(_0x152022(0xf2))/(-0x215+-0x2687+-0x4*-0xa2a));if(_0x384d4b===_0x32dec1)break;else _0x1cf24b['push'](_0x1cf24b['shift']());}catch(_0x8a5c98){_0x1cf24b['push'](_0x1cf24b['shift']());}}}(_0x2e5f,-0x64ab7*-0x1+0x4083f+-0x3f771));import{info,warn,error}from'../utils/logger.js';import{db}from'../utils/database.js';import{userJidFromCtx as _0x376a2a}from'../utils/sudo.js';export const name=_0x150093(0xc2);export const version=_0x150093(0x101);export const priority=-0x1*-0x181f+0xc87+-0x1*0x24a1;let botInstance=null,cleanupInterval=null;const FALLBACKS={'RETENTION_MINUTES':0xf,'CLEANUP_INTERVAL_MS':(0x1b3*0x13+0x1e1b+-0xdd*0x48)*(-0x2ad*-0x2+0x1693+-0x8f*0x2b)};let RETENTION_MINUTES=FALLBACKS['RETENTION_'+'MINUTES'],CLEANUP_INTERVAL_MS=FALLBACKS['CLEANUP_IN'+_0x150093(0xd8)];function _0x2e5f(){const _0x1810ea=['find','[sudonumbe','SELECT\x20msg','er\x20TEXT,\x0a\x20','r]\x20failed\x20','nder_jid\x20T','M\x20message_','msg_id','ized','EY,\x0a\x20\x20\x20\x20se','senders\x20(m','removeList','\x20old\x20sende','\x20threw:\x20','9kKFQuv','r]\x20attache','3181092dmMJEo','map','age_sender','\x20\x20saved_at','er,\x20chat_j','\x20saved_at\x20','participan','15clTwaB','\x20IN\x20(','join','d_at\x20<\x20?','_id,\x20sende','r_jid,\x20sen','key','ender_numb','1.0.1','replace','\x20FROM\x20mess','CREATE\x20TAB','essage_sen','ener','run','88332osTLml','CLEANUP_IN','all',',\x20?,\x20?,\x20?,','\x20failed:\x20','e\x20requires','dler\x20error','_id\x20FROM\x20m',',\x20saved_at','isArray','er\x20error:\x20','findings','remoteJid','58101jpVtsO','messages.u','822432qpOLYy','sUpsertHan','r]\x20initial','\x20VALUES\x20(?','string','\x20);','\x20?)','g_id\x20=\x20?','ng\x20failed:','6374336dHldvH','40dThJot','jid','Old\x20error:','toLowerCas','slice','indexOf','sender_pn','\x20initializ','d\x20to\x20messa','length','\x20bot\x20arg','sudonumber','INSERT\x20OR\x20','lid','r]\x20cleanup','11tmlCkO','\x20PRIMARY\x20K','sg_id\x20TEXT','message','1809772eednch','r]\x20userjid','catch','DELETE\x20FRO','r]\x20getSend','7MmYJLQ','tAlt','psert','id,\x20saved_','5837210fcniuK','MINUTES','\x20\x20\x20chat_ji','EXISTS\x20mes','O\x20message_','TERVAL_MS','psert:\x20','senders\x20WH','to\x20attach\x20','field','der_jid,\x20s','r]\x20per-mes','r]\x20message','rror:\x20','r]\x20saveSen'];_0x2e5f=function(){return _0x1810ea;};return _0x2e5f();}function nowSeconds(){return Math['floor'](Date['now']()/(0x843*-0x2+-0x13a0+-0x1*-0x280e));}function _0x529d(_0x3483d2,_0x328280){const _0x3839bd=_0x2e5f();return _0x529d=function(_0x31d52b,_0x4d2068){_0x31d52b=_0x31d52b-(-0x7ad+-0x9ac*-0x1+-0x14f);let _0x3efaff=_0x3839bd[_0x31d52b];return _0x3efaff;},_0x529d(_0x3483d2,_0x328280);}async function ensureTable(){const _0x51ab49=_0x150093;await db['exec'](_0x51ab49(0x104)+'LE\x20IF\x20NOT\x20'+_0x51ab49(0xd6)+'sage_sende'+'rs\x20(\x0a\x20\x20\x20\x20m'+_0x51ab49(0xc8)+_0x51ab49(0xc7)+_0x51ab49(0xeb)+_0x51ab49(0xe7)+'EXT,\x0a\x20\x20\x20\x20s'+_0x51ab49(0x100)+_0x51ab49(0xe5)+_0x51ab49(0xd5)+'d\x20TEXT,\x0a\x20\x20'+_0x51ab49(0xf5)+'\x20INTEGER\x0a\x20'+_0x51ab49(0xb2));}function normalizeNumberFromSudoJid(_0x583bf2){const _0xc71623=_0x150093;if(!_0x583bf2)return'';try{const _0x3d40c3=String(_0x583bf2),_0x4b1ae8=_0x3d40c3['indexOf']('@'),_0x2581f1=_0x4b1ae8===-(0xb*0x239+-0x16ea+-0x188)?_0x3d40c3:_0x3d40c3[_0xc71623(0xbb)](0xdfa+0x26dc+-0x34d6,_0x4b1ae8),_0x1dff21=_0x2581f1['indexOf'](':'),_0x32f36f=_0x1dff21===-(-0x1c37+-0x1b3f+0x127d*0x3)?_0x2581f1:_0x2581f1[_0xc71623(0xbb)](-0x1*-0x20a1+0x1e3+-0x2284,_0x1dff21);return _0x32f36f[_0xc71623(0x102)](/^\+/,'');}catch{return String(_0x583bf2||'');}}async function saveSenderIfMissing(_0x419620,_0x2440b4,_0x1ad32e){const _0xa07eaf=_0x150093;if(!_0x419620||!_0x2440b4)return![];const _0x1e81b2=normalizeNumberFromSudoJid(_0x2440b4),_0x1f51ca=nowSeconds();try{return await db[_0xa07eaf(0x107)](_0xa07eaf(0xc3)+'IGNORE\x20INT'+_0xa07eaf(0xd7)+_0xa07eaf(0xec)+'sg_id,\x20sen'+_0xa07eaf(0xdd)+_0xa07eaf(0x100)+_0xa07eaf(0xf6)+_0xa07eaf(0xd2)+'at)\x0a\x20\x20\x20\x20\x20\x20'+_0xa07eaf(0xb0)+_0xa07eaf(0x10b)+_0xa07eaf(0xb3),[_0x419620,_0x2440b4,_0x1e81b2||null,_0x1ad32e||null,_0x1f51ca]),!![];}catch(_0x5b724d){return warn(_0xa07eaf(0xe3)+_0xa07eaf(0xe1)+'derIfMissi'+_0xa07eaf(0xb5)+'\x20'+(_0x5b724d?.['message']||_0x5b724d)),![];}}export async function getSenderForMsg(_0xd971ac){const _0xa2780f=_0x150093;if(!_0xd971ac)return null;try{const _0x1e3ec3=await db['get'](_0xa2780f(0xe4)+_0xa2780f(0xfd)+_0xa2780f(0xfe)+'der_number'+',\x20chat_jid'+_0xa2780f(0x110)+_0xa2780f(0x103)+_0xa2780f(0xf4)+'s\x20WHERE\x20ms'+_0xa2780f(0xb4),[_0xd971ac]);return _0x1e3ec3||null;}catch(_0x456c4f){return warn(_0xa2780f(0xe3)+_0xa2780f(0xce)+'erForMsg\x20e'+_0xa2780f(0xe0)+(_0x456c4f?.['message']||_0x456c4f)),null;}}async function cleanupOld(){const _0x25c53e=_0x150093;try{const _0x4abb92=nowSeconds()-Number(RETENTION_MINUTES||FALLBACKS['RETENTION_'+_0x25c53e(0xd4)])*(-0x1*0x16f+-0x1*0x12ad+0x516*0x4),_0x111171=await db[_0x25c53e(0x10a)](_0x25c53e(0xe4)+_0x25c53e(0x10f)+_0x25c53e(0x105)+'ders\x20WHERE'+_0x25c53e(0xf7)+'IS\x20NOT\x20NUL'+'L\x20AND\x20save'+_0x25c53e(0xfc),[_0x4abb92]);if(!_0x111171||_0x111171[_0x25c53e(0xc0)]===-0x2c8*0x7+-0x1d02+0x9b2*0x5)return;const _0x35c36b=_0x111171['map'](_0x139cbf=>_0x139cbf[_0x25c53e(0xe9)]),_0x5ee47e=0x212b+0x107*0x17+-0x6*0x956;for(let _0x1bbf99=0x963+-0x2*-0x751+-0x1805;_0x1bbf99<_0x35c36b[_0x25c53e(0xc0)];_0x1bbf99+=_0x5ee47e){const _0x397a98=_0x35c36b[_0x25c53e(0xbb)](_0x1bbf99,_0x1bbf99+_0x5ee47e),_0x4a8e30=_0x397a98[_0x25c53e(0xf3)](()=>'?')[_0x25c53e(0xfb)](',');await db[_0x25c53e(0x107)](_0x25c53e(0xcd)+_0x25c53e(0xe8)+_0x25c53e(0xda)+'ERE\x20msg_id'+_0x25c53e(0xfa)+_0x4a8e30+')',_0x397a98);}info(_0x25c53e(0xe3)+'r]\x20cleaned'+'\x20'+_0x111171[_0x25c53e(0xc0)]+(_0x25c53e(0xee)+'r\x20rows'));}catch(_0xd0b249){warn(_0x25c53e(0xe3)+_0x25c53e(0xc5)+_0x25c53e(0xb9)+'\x20'+(_0xd0b249?.[_0x25c53e(0xc9)]||_0xd0b249));}}async function messagesUpsertHandler({messages:_0x302524}){const _0x29e7fa=_0x150093;try{if(!_0x302524||!Array['isArray'](_0x302524))return;for(const _0x810664 of _0x302524){try{if(!_0x810664||!_0x810664[_0x29e7fa(0xff)])continue;if(_0x810664[_0x29e7fa(0xff)]['fromMe'])continue;const _0x29ac2b=_0x810664[_0x29e7fa(0xff)]?.['id']||_0x810664['id']||_0x810664['message']&&_0x810664[_0x29e7fa(0xc9)][_0x29e7fa(0xff)]&&_0x810664[_0x29e7fa(0xc9)]['key']['id']||null;if(!_0x29ac2b)continue;const _0x5ce66d=await getSenderForMsg(_0x29ac2b);if(_0x5ce66d)continue;let _0x55844c=[];try{const _0x3b59f8=_0x376a2a(_0x810664);_0x55844c=_0x3b59f8&&Array[_0x29e7fa(0x111)](_0x3b59f8[_0x29e7fa(0x113)])?_0x3b59f8[_0x29e7fa(0x113)]:[];}catch(_0xd4aae2){warn(_0x29e7fa(0xe3)+_0x29e7fa(0xcb)+_0x29e7fa(0xef)+(_0xd4aae2?.[_0x29e7fa(0xc9)]||_0xd4aae2)),_0x55844c=[];}if(!_0x55844c['length'])continue;const _0x4561ad=['remoteJidA'+'lt',_0x29e7fa(0xbd),_0x29e7fa(0xf8)+_0x29e7fa(0xd0),_0x29e7fa(0xf8)+'t_pn'];let _0x40ebf3=null;for(const _0x21a140 of _0x4561ad){_0x40ebf3=_0x55844c[_0x29e7fa(0xe2)](_0x2df632=>_0x2df632[_0x29e7fa(0xdc)]===_0x21a140&&typeof _0x2df632[_0x29e7fa(0xb8)]===_0x29e7fa(0xb1));if(_0x40ebf3)break;}if(!_0x40ebf3)_0x40ebf3=_0x55844c[-0x623*0x4+-0x1*-0x19ea+-0x15e];if(!_0x40ebf3||!_0x40ebf3['jid']||typeof _0x40ebf3[_0x29e7fa(0xb8)]!=='string')continue;const _0x481401=_0x40ebf3[_0x29e7fa(0xb8)][_0x29e7fa(0xbc)]('@'),_0x32e5dd=_0x481401===-(-0x856+-0xb*-0x1c3+0x3ae*-0x3)?'':_0x40ebf3[_0x29e7fa(0xb8)]['slice'](_0x481401+(0xe2*-0x17+0xcd7+-0xef*-0x8));if(!_0x32e5dd||_0x32e5dd[_0x29e7fa(0xba)+'e']()===_0x29e7fa(0xc4))continue;await saveSenderIfMissing(_0x29ac2b,_0x40ebf3[_0x29e7fa(0xb8)],_0x810664[_0x29e7fa(0xff)]?.[_0x29e7fa(0x114)]||null);}catch(_0x83e4ba){warn(_0x29e7fa(0xe3)+_0x29e7fa(0xde)+'sage\x20handl'+_0x29e7fa(0x112)+(_0x83e4ba?.[_0x29e7fa(0xc9)]||_0x83e4ba));}}}catch(_0x82a44e){warn(_0x29e7fa(0xe3)+_0x29e7fa(0xdf)+_0x29e7fa(0x118)+_0x29e7fa(0x10e)+':\x20'+(_0x82a44e?.['message']||_0x82a44e));}}export async function initialize(_0x219b8a){const _0x93c55c=_0x150093;if(!_0x219b8a)throw new Error('sudonumber'+_0x93c55c(0xbe)+_0x93c55c(0x10d)+_0x93c55c(0xc1));botInstance=_0x219b8a,await ensureTable()[_0x93c55c(0xcc)](_0xdb974=>{const _0x27ddb0=_0x93c55c;error(_0xdb974,_0x27ddb0(0xe3)+'r]\x20DB\x20init'+_0x27ddb0(0x10c)+(_0xdb974?.['message']||_0xdb974));throw _0xdb974;});try{botInstance['on'](_0x93c55c(0x116)+'psert',messagesUpsertHandler),info('[sudonumbe'+_0x93c55c(0xf1)+_0x93c55c(0xbf)+'ges.upsert');}catch(_0xdd08e5){warn('[sudonumbe'+_0x93c55c(0xe6)+_0x93c55c(0xdb)+_0x93c55c(0x116)+_0x93c55c(0xd9)+(_0xdd08e5?.[_0x93c55c(0xc9)]||_0xdd08e5));}if(cleanupInterval)clearInterval(cleanupInterval);cleanupInterval=setInterval(cleanupOld,Number(CLEANUP_INTERVAL_MS||FALLBACKS[_0x93c55c(0x109)+_0x93c55c(0xd8)])),info('[sudonumbe'+_0x93c55c(0x119)+_0x93c55c(0xea));}export async function cleanup(){const _0x55352d=_0x150093;try{if(botInstance&&typeof botInstance[_0x55352d(0xed)+_0x55352d(0x106)]==='function')botInstance[_0x55352d(0xed)+_0x55352d(0x106)](_0x55352d(0x116)+_0x55352d(0xd1),messagesUpsertHandler);if(cleanupInterval)clearInterval(cleanupInterval);cleanupInterval=null;}catch(_0x5e23dc){warn(_0x55352d(0xe3)+_0x55352d(0xc5)+'\x20error:\x20'+(_0x5e23dc?.[_0x55352d(0xc9)]||_0x5e23dc));}finally{botInstance=null;}}export default{'name':name,'version':version,'initialize':initialize,'cleanup':cleanup,'getSenderForMsg':getSenderForMsg};