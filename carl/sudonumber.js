const _0x3413d1=_0x206c;(function(_0x255091,_0x4046da){const _0x13259e=_0x206c,_0x3b251b=_0x255091();while(!![]){try{const _0x12613c=-parseInt(_0x13259e(0x213))/(0x7*0x31d+-0x1f*-0xe5+-0x3185)+-parseInt(_0x13259e(0x1e5))/(0x1f99*-0x1+0xbc6*0x2+0x80f)+-parseInt(_0x13259e(0x1fc))/(0x1*0x23c1+0xc48+-0x3006)*(-parseInt(_0x13259e(0x1dd))/(0x8d*-0xb+-0x14b9+-0x1*-0x1acc))+-parseInt(_0x13259e(0x202))/(-0x1e31+0x1007+0xe2f*0x1)+-parseInt(_0x13259e(0x1c6))/(0x1dfc+-0x1378+-0xa7e)+parseInt(_0x13259e(0x1e9))/(-0x192*0xf+0x3*0x7cd+0x2e)*(-parseInt(_0x13259e(0x1e3))/(-0x223f*-0x1+0xd8d*-0x1+0x2e*-0x73))+parseInt(_0x13259e(0x20d))/(-0xb*-0x340+0x924+-0x2cdb);if(_0x12613c===_0x4046da)break;else _0x3b251b['push'](_0x3b251b['shift']());}catch(_0x25eef7){_0x3b251b['push'](_0x3b251b['shift']());}}}(_0x1ff8,-0xab*0xffc+-0x2*0x1c36+0x10bc18));function _0x206c(_0x2cbe51,_0x175220){_0x2cbe51=_0x2cbe51-(-0x8f4+0x72d+0x386);const _0x49c227=_0x1ff8();let _0x51f2e1=_0x49c227[_0x2cbe51];return _0x51f2e1;}import{info,warn,error}from'../utils/logger.js';import{db}from'../utils/database.js';import{userJidFromCtx as _0x51160b}from'../utils/sudo.js';export const name=_0x3413d1(0x1ed);export const version=_0x3413d1(0x1c3);export const priority=0x2707*-0x1+-0x3e1+0x2aed;let botInstance=null,cleanupInterval=null;const FALLBACKS={'RETENTION_MINUTES':0xf,'CLEANUP_INTERVAL_MS':(-0x1e5f+-0x11b*0x23+0x454c)*(0x1d6*0x4+0x1cf3+-0x2063)};let RETENTION_MINUTES=FALLBACKS['RETENTION_'+_0x3413d1(0x218)],CLEANUP_INTERVAL_MS=FALLBACKS[_0x3413d1(0x21e)+_0x3413d1(0x1fd)];function nowSeconds(){const _0x3906cc=_0x3413d1;return Math[_0x3906cc(0x200)](Date[_0x3906cc(0x1f6)]()/(0x82*-0x19+0xd72*-0x1+-0xf06*-0x2));}async function ensureTable(){const _0x17a203=_0x3413d1;await db[_0x17a203(0x1f1)](_0x17a203(0x21f)+_0x17a203(0x224)+'EXISTS\x20mes'+_0x17a203(0x21b)+_0x17a203(0x203)+_0x17a203(0x20c)+_0x17a203(0x1e7)+'EY,\x0a\x20\x20\x20\x20se'+_0x17a203(0x201)+'EXT,\x0a\x20\x20\x20\x20s'+_0x17a203(0x1de)+_0x17a203(0x1f7)+_0x17a203(0x1d1)+_0x17a203(0x1d8)+_0x17a203(0x210)+'\x20INTEGER\x0a\x20'+_0x17a203(0x1f2));}function normalizeNumberFromSudoJid(_0x40c079){const _0x5a4537=_0x3413d1;if(!_0x40c079)return'';try{const _0x5d3115=String(_0x40c079),_0x152cef=_0x5d3115['indexOf']('@'),_0xbcb7f5=_0x152cef===-(-0x67*-0x1+0x59e*0x1+0x4d*-0x14)?_0x5d3115:_0x5d3115[_0x5a4537(0x1e8)](0x35*0x35+-0x2242+0x1749,_0x152cef),_0x483911=_0xbcb7f5[_0x5a4537(0x220)](':'),_0x55fd07=_0x483911===-(0x30*0x11+-0x8*-0x36b+-0x1e87)?_0xbcb7f5:_0xbcb7f5['slice'](0x2*0x3c2+0x2190+0x4*-0xa45,_0x483911);return _0x55fd07['replace'](/^\+/,'');}catch{return String(_0x40c079||'');}}async function saveSenderIfMissing(_0x472fc6,_0x395f4c,_0x24b322){const _0xbdf478=_0x3413d1;if(!_0x472fc6||!_0x395f4c)return![];const _0x5e3dd2=normalizeNumberFromSudoJid(_0x395f4c),_0x5143ac=nowSeconds();try{return await db['run']('INSERT\x20OR\x20'+_0xbdf478(0x222)+'O\x20message_'+_0xbdf478(0x1d5)+'sg_id,\x20sen'+'der_jid,\x20s'+'ender_numb'+'er,\x20chat_j'+_0xbdf478(0x1cb)+_0xbdf478(0x1f8)+_0xbdf478(0x21c)+_0xbdf478(0x1da)+_0xbdf478(0x1c2),[_0x472fc6,_0x395f4c,_0x5e3dd2||null,_0x24b322||null,_0x5143ac]),!![];}catch(_0x4d79e7){return warn('[sudonumbe'+_0xbdf478(0x1e1)+_0xbdf478(0x1c4)+'ng\x20failed:'+'\x20'+(_0x4d79e7?.[_0xbdf478(0x1cd)]||_0x4d79e7)),![];}}export async function getSenderForMsg(_0x20eb6c){const _0x4a384d=_0x3413d1;if(!_0x20eb6c)return null;try{const _0x46d175=await db['get'](_0x4a384d(0x1cf)+_0x4a384d(0x1fa)+_0x4a384d(0x1e4)+_0x4a384d(0x1c5)+_0x4a384d(0x1d2)+_0x4a384d(0x20f)+_0x4a384d(0x1c1)+_0x4a384d(0x1e2)+_0x4a384d(0x206)+'g_id\x20=\x20?',[_0x20eb6c]);return _0x46d175||null;}catch(_0xa0d658){return warn(_0x4a384d(0x1dc)+_0x4a384d(0x1ee)+'erForMsg\x20e'+'rror:\x20'+(_0xa0d658?.[_0x4a384d(0x1cd)]||_0xa0d658)),null;}}async function cleanupOld(){const _0x1b4eaf=_0x3413d1;try{const _0x213b80=nowSeconds()-Number(RETENTION_MINUTES||FALLBACKS['RETENTION_'+'MINUTES'])*(0x1077+-0x147*0x15+0xa98),_0x5bdcd6=await db['all'](_0x1b4eaf(0x1cf)+'_id\x20FROM\x20m'+_0x1b4eaf(0x214)+_0x1b4eaf(0x227)+_0x1b4eaf(0x1d7)+'IS\x20NOT\x20NUL'+_0x1b4eaf(0x204)+_0x1b4eaf(0x1c0),[_0x213b80]);if(!_0x5bdcd6||_0x5bdcd6[_0x1b4eaf(0x1ea)]===-0x7*-0x371+-0x26b4*-0x1+-0x3ecb*0x1)return;const _0x5c5e8e=_0x5bdcd6['map'](_0x482ac9=>_0x482ac9[_0x1b4eaf(0x1ce)]),_0x4505f8=-0x2334+-0x1*-0x1cb5+0x747;for(let _0x3a7c22=0x9b8+0x1*-0x24b3+0x1afb;_0x3a7c22<_0x5c5e8e[_0x1b4eaf(0x1ea)];_0x3a7c22+=_0x4505f8){const _0x80dff9=_0x5c5e8e[_0x1b4eaf(0x1e8)](_0x3a7c22,_0x3a7c22+_0x4505f8),_0x31b01a=_0x80dff9['map'](()=>'?')[_0x1b4eaf(0x209)](',');await db[_0x1b4eaf(0x221)](_0x1b4eaf(0x1d0)+_0x1b4eaf(0x207)+_0x1b4eaf(0x225)+_0x1b4eaf(0x1c8)+'\x20IN\x20('+_0x31b01a+')',_0x80dff9);}info(_0x1b4eaf(0x1dc)+'r]\x20cleaned'+'\x20'+_0x5bdcd6['length']+(_0x1b4eaf(0x1fe)+'r\x20rows'));}catch(_0xd0ae52){warn('[sudonumbe'+'r]\x20cleanup'+_0x1b4eaf(0x1ef)+'\x20'+(_0xd0ae52?.['message']||_0xd0ae52));}}async function messagesUpsertHandler({messages:_0x15f706}){const _0x23660a=_0x3413d1;try{if(!_0x15f706||!Array[_0x23660a(0x217)](_0x15f706))return;for(const _0x516509 of _0x15f706){try{if(!_0x516509||!_0x516509[_0x23660a(0x1df)])continue;if(_0x516509[_0x23660a(0x1df)][_0x23660a(0x1f3)])continue;const _0x251f0b=_0x516509[_0x23660a(0x1df)]?.['id']||_0x516509['id']||_0x516509[_0x23660a(0x1cd)]&&_0x516509[_0x23660a(0x1cd)][_0x23660a(0x1df)]&&_0x516509['message'][_0x23660a(0x1df)]['id']||null;if(!_0x251f0b)continue;const _0x38585f=await getSenderForMsg(_0x251f0b);if(_0x38585f)continue;let _0x344ef8=[];try{const _0x434eba=_0x51160b(_0x516509);_0x344ef8=_0x434eba&&Array[_0x23660a(0x217)](_0x434eba[_0x23660a(0x1ca)])?_0x434eba[_0x23660a(0x1ca)]:[];}catch(_0x40cde0){warn(_0x23660a(0x1dc)+_0x23660a(0x215)+_0x23660a(0x1d9)+(_0x40cde0?.[_0x23660a(0x1cd)]||_0x40cde0)),_0x344ef8=[];}if(!_0x344ef8[_0x23660a(0x1ea)])continue;const _0x542d98=[_0x23660a(0x1d3)+'lt',_0x23660a(0x1f4),_0x23660a(0x1db)+_0x23660a(0x223),'participan'+_0x23660a(0x1f5)];let _0x1b7ff5=null;for(const _0x5f5874 of _0x542d98){_0x1b7ff5=_0x344ef8[_0x23660a(0x1ec)](_0x347c08=>_0x347c08['field']===_0x5f5874&&typeof _0x347c08[_0x23660a(0x208)]===_0x23660a(0x1c9));if(_0x1b7ff5)break;}if(!_0x1b7ff5)_0x1b7ff5=_0x344ef8[0x3f+0x1f8c+-0x1fcb];if(!_0x1b7ff5||!_0x1b7ff5[_0x23660a(0x208)]||typeof _0x1b7ff5[_0x23660a(0x208)]!=='string')continue;const _0x2c704d=_0x1b7ff5[_0x23660a(0x208)][_0x23660a(0x220)]('@'),_0x158069=_0x2c704d===-(-0x10d7+-0x1d06*0x1+0x2dde)?'':_0x1b7ff5[_0x23660a(0x208)][_0x23660a(0x1e8)](_0x2c704d+(-0xf2*-0x3+0x1*0x1c92+-0x1f67));if(!_0x158069||_0x158069[_0x23660a(0x1fb)+'e']()===_0x23660a(0x212))continue;await saveSenderIfMissing(_0x251f0b,_0x1b7ff5[_0x23660a(0x208)],_0x516509[_0x23660a(0x1df)]?.[_0x23660a(0x1d4)]||null);}catch(_0x1b92cc){warn('[sudonumbe'+'r]\x20per-mes'+_0x23660a(0x21d)+'er\x20error:\x20'+(_0x1b92cc?.[_0x23660a(0x1cd)]||_0x1b92cc));}}}catch(_0x53ec02){warn(_0x23660a(0x1dc)+_0x23660a(0x20e)+'sUpsertHan'+_0x23660a(0x21a)+':\x20'+(_0x53ec02?.['message']||_0x53ec02));}}export async function initialize(_0x531b20){const _0x1ce815=_0x3413d1;if(!_0x531b20)throw new Error(_0x1ce815(0x1ed)+_0x1ce815(0x20b)+_0x1ce815(0x205)+_0x1ce815(0x1eb));botInstance=_0x531b20,await ensureTable()[_0x1ce815(0x1cc)](_0x5fc547=>{const _0x305b0b=_0x1ce815;error(_0x5fc547,_0x305b0b(0x1dc)+'r]\x20DB\x20init'+_0x305b0b(0x1e0)+(_0x5fc547?.[_0x305b0b(0x1cd)]||_0x5fc547));throw _0x5fc547;});try{botInstance['on'](_0x1ce815(0x1f9)+_0x1ce815(0x1f0),messagesUpsertHandler),info(_0x1ce815(0x1dc)+_0x1ce815(0x1c7)+_0x1ce815(0x20a)+_0x1ce815(0x1d6));}catch(_0x1ea3b7){warn(_0x1ce815(0x1dc)+_0x1ce815(0x219)+_0x1ce815(0x1e6)+_0x1ce815(0x1f9)+'psert:\x20'+(_0x1ea3b7?.[_0x1ce815(0x1cd)]||_0x1ea3b7));}if(cleanupInterval)clearInterval(cleanupInterval);cleanupInterval=setInterval(cleanupOld,Number(CLEANUP_INTERVAL_MS||FALLBACKS[_0x1ce815(0x21e)+_0x1ce815(0x1fd)])),info(_0x1ce815(0x1dc)+'r]\x20initial'+_0x1ce815(0x1bf));}export async function cleanup(){const _0x1e8e3c=_0x3413d1;try{if(botInstance&&typeof botInstance[_0x1e8e3c(0x1ff)+_0x1e8e3c(0x226)]===_0x1e8e3c(0x216))botInstance[_0x1e8e3c(0x1ff)+_0x1e8e3c(0x226)]('messages.u'+'psert',messagesUpsertHandler);if(cleanupInterval)clearInterval(cleanupInterval);cleanupInterval=null;}catch(_0x4035ac){warn('[sudonumbe'+_0x1e8e3c(0x228)+_0x1e8e3c(0x211)+(_0x4035ac?.[_0x1e8e3c(0x1cd)]||_0x4035ac));}finally{botInstance=null;}}function _0x1ff8(){const _0x37aa6a=[',\x20chat_jid','remoteJidA','remoteJid','senders\x20(m','ges.upsert','\x20saved_at\x20','d\x20TEXT,\x0a\x20\x20','\x20threw:\x20',',\x20?,\x20?,\x20?,','participan','[sudonumbe','2116CTCCxc','ender_numb','key','\x20failed:\x20','r]\x20saveSen','age_sender','23720pcpWXn','r_jid,\x20sen','1453114xJkggW','to\x20attach\x20','\x20PRIMARY\x20K','slice','889PcEaZB','length','\x20bot\x20arg','find','sudonumber','r]\x20getSend','Old\x20error:','psert','exec','\x20);','fromMe','sender_pn','t_pn','now','er\x20TEXT,\x0a\x20','at)\x0a\x20\x20\x20\x20\x20\x20','messages.u','_id,\x20sende','toLowerCas','1095XoWOIm','TERVAL_MS','\x20old\x20sende','removeList','floor','nder_jid\x20T','725325jIQedr','rs\x20(\x0a\x20\x20\x20\x20m','L\x20AND\x20save','e\x20requires','s\x20WHERE\x20ms','M\x20message_','jid','join','d\x20to\x20messa','\x20initializ','sg_id\x20TEXT','19561662pLcuPa','r]\x20message',',\x20saved_at','\x20\x20saved_at','\x20error:\x20','lid','16072LWGCsZ','essage_sen','r]\x20userjid','function','isArray','MINUTES','r]\x20failed\x20','dler\x20error','sage_sende','\x20VALUES\x20(?','sage\x20handl','CLEANUP_IN','CREATE\x20TAB','indexOf','run','IGNORE\x20INT','tAlt','LE\x20IF\x20NOT\x20','senders\x20WH','ener','ders\x20WHERE','r]\x20cleanup','ized','d_at\x20<\x20?','\x20FROM\x20mess','\x20?)','1.0.1','derIfMissi','der_number','4318812NcjWyu','r]\x20attache','ERE\x20msg_id','string','findings','id,\x20saved_','catch','message','msg_id','SELECT\x20msg','DELETE\x20FRO','\x20\x20\x20chat_ji'];_0x1ff8=function(){return _0x37aa6a;};return _0x1ff8();}export default{'name':name,'version':version,'initialize':initialize,'cleanup':cleanup,'getSenderForMsg':getSenderForMsg};